name: Cleanup old workflow runs and releases

on:
  schedule:
    - cron: '0 3 * * *' # 每天 UTC 03:00 运行
  workflow_dispatch: {}

permissions:
  actions: write
  contents: write

jobs:
  cleanup:
    name: Cleanup runs & releases
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old workflow runs and releases
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1) 遍历 repo 中的 workflows：
            //    - 永远保留每个 workflow 的最新一次 run
            //    - 删除年龄超过 7 天的其它 runs
            const wfList = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const weekMs = 7 * 24 * 60 * 60 * 1000;
            const cutoff = new Date(Date.now() - weekMs);
            for (const wf of (wfList.data.workflows || [])) {
              try {
                const runsRes = await github.rest.actions.listWorkflowRuns({ owner, repo, workflow_id: wf.id, per_page: 100 });
                const runs = (runsRes.data.workflow_runs || []).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                for (const run of runs) {
                  try {
                    const created = new Date(run.created_at);
                    if (created < cutoff) {
                      await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                      console.log(`Deleted run ${run.id} of workflow ${wf.name} (created_at=${run.created_at})`);
                    } else {
                      console.log(`Keeping recent run ${run.id} of workflow ${wf.name} (created_at=${run.created_at})`);
                    }
                  } catch (err) {
                    console.log(`Failed to delete run ${run.id}: ${err}`);
                  }
                }
              } catch (err) {
                console.log(`Error processing workflow ${wf.name}: ${err}`);
              }
            }

            // 2) 列出 releases：
            //    - 永远保留最新的 release
            //    - 删除创建时间早于 7 天前的其余 release（并尝试删除对应的 tag）
            try {
              const relRes = await github.rest.repos.listReleases({ owner, repo, per_page: 100 });
              const releases = (relRes.data || []).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
              for (const r of releases) {
                try {
                  const created = new Date(r.created_at);
                  if (created < cutoff) {
                    await github.rest.repos.deleteRelease({ owner, repo, release_id: r.id });
                    console.log(`Deleted release ${r.id} (${r.tag_name}) created_at=${r.created_at}`);
                    if (r.tag_name) {
                      try {
                        await github.rest.git.deleteRef({ owner, repo, ref: `tags/${r.tag_name}` });
                        console.log(`Deleted tag ref tags/${r.tag_name}`);
                      } catch (e) {
                        console.log(`Failed to delete tag ref tags/${r.tag_name}: ${e}`);
                      }
                    }
                  } else {
                    console.log(`Keeping recent release ${r.id} (${r.tag_name}) created_at=${r.created_at}`);
                  }
                } catch (err) {
                  console.log(`Failed to delete release ${r.id}: ${err}`);
                }
              }
            } catch (err) {
              console.log(`Error listing releases: ${err}`);
            }

            console.log('Cleanup job completed');